name: Build Android APK

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade buildozer python-for-android cython wheel
          # 필요시: pip install --upgrade buildozer python-for-android==2024.1.21 cython wheel

      # 캐시 완전 삭제 (이전 armv7/NDK 흔적 제거)
      - name: Clean buildozer caches (local & global)
        run: |
          rm -rf .buildozer
          rm -rf $GITHUB_WORKSPACE/.buildozer_global
          rm -rf $HOME/.buildozer

      - name: Sanity check spec
        run: |
          echo "[android] quick check:"
          grep -E '^(android\.api|android\.minapi|android\.ndk_api|android\.archs)' buildozer.spec || true

      # ▶ SDK 경로 생성을 위해 1회 부트스트랩(실패 무시)
      - name: Bootstrap SDK (non-fatal)
        run: |
          set +e
          buildozer android debug
          exit 0

      # ▶ 라이선스 자동수락 + 필수 패키지 설치
      - name: Accept SDK licenses & install packages
        run: |
          SDK="$HOME/.buildozer/android/platform/android-sdk"
          if [ ! -x "$SDK/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "sdkmanager not found at $SDK; listing tree for debug:"
            ls -la "$HOME/.buildozer/android/platform" || true
          fi
          yes | "$SDK/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK" --licenses
          # 우선 최신 시도 후, 안 되면 34 라인으로 폴백
          yes | "$SDK/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK" \
              "platform-tools" "platforms;android-34" "build-tools;36.1.0" || true
          yes | "$SDK/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK" \
              "platform-tools" "platforms;android-34" "build-tools;36.0.0" || true
          yes | "$SDK/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK" \
              "platform-tools" "platforms;android-34" "build-tools;34.0.0" || true

      # ▶ 실제 빌드 재실행
      - name: Build (verbose)
        env:
          P4A_LOG_LEVEL: "2"
        run: |
          buildozer --verbose android debug

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: slabcalc-arm64
          path: bin/*.apk
